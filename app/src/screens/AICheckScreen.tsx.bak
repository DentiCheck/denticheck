import React, { useMemo, useState } from "react";
import {
  ActivityIndicator,
  Alert,
  Image,
  Linking,
  ScrollView,
  Text,
  TouchableOpacity,
  View,
} from "react-native";
import * as ImagePicker from "expo-image-picker";
import { Camera, ImagePlus } from "lucide-react-native";
import { SafeAreaView } from "react-native-safe-area-context";

import { Button } from "../shared/components/ui/Button";
import { useAuth } from "../shared/providers/AuthProvider";

type BBox = { x: number; y: number; w: number; h: number };
type Detection = { label: string; confidence: number; bbox: BBox };

type LlmResult = {
  overall?: {
    level?: "GREEN" | "YELLOW" | "RED";
    badgeText?: string;
    oneLineSummary?: string;
  };
};

type SelectedImage = {
  uri: string;
  fileName: string;
  mimeType: string;
};

type AiCheckResponse = {
  sessionId: string;
  status: "uploaded" | "quality_failed" | "analyzing" | "done" | "error";
  storageKey: string;
  imageUrl: string;
  qualityPass: boolean;
  qualityScore: number;
  qualityReasons: string[];
  detections: Detection[];
  summary: Record<string, unknown>;
  llmResult?: LlmResult;
  pdfUrl?: string;
};

const API_BASE_URL = process.env.EXPO_PUBLIC_API_SERVER_URL;
const REQUEST_TIMEOUT_MS = 120_000;

export default function AICheckScreen() {
  const { token } = useAuth();
  const [selectedImage, setSelectedImage] = useState<SelectedImage | null>(null);
  const [uiState, setUiState] = useState<"idle" | "loading" | "success" | "error">("idle");
  const [result, setResult] = useState<AiCheckResponse | null>(null);
  const [errorMessage, setErrorMessage] = useState<string>("");

  const canAnalyze = useMemo(
    () => !!selectedImage && uiState !== "loading",
    [selectedImage, uiState],
  );

  const pickImage = async (useCamera: boolean) => {
    const permission = useCamera
      ? await ImagePicker.requestCameraPermissionsAsync()
      : await ImagePicker.requestMediaLibraryPermissionsAsync();

    if (!permission.granted) {
      Alert.alert("권한 필요", useCamera ? "카메라 권한이 필요합니다." : "갤러리 권한이 필요합니다.");
      return;
    }

    const picked = useCamera
      ? await ImagePicker.launchCameraAsync({
          mediaTypes: ImagePicker.MediaTypeOptions.Images,
          allowsEditing: true,
          quality: 1,
        })
      : await ImagePicker.launchImageLibraryAsync({
          mediaTypes: ImagePicker.MediaTypeOptions.Images,
          allowsEditing: true,
          quality: 1,
        });

    if (picked.canceled) return;

    const asset = picked.assets[0];
    const uri = asset?.uri;
    if (!uri) {
      Alert.alert("오류", "이미지를 불러오지 못했습니다.");
      return;
    }

    const fileName =
      asset.fileName ?? `ai-check-${Date.now()}.${asset.mimeType?.split("/")[1] ?? "jpg"}`;
    const mimeType =
      asset.mimeType ??
      (fileName.endsWith(".png")
        ? "image/png"
        : fileName.endsWith(".webp")
          ? "image/webp"
          : "image/jpeg");

    setSelectedImage({ uri, fileName, mimeType });
    setResult(null);
    setErrorMessage("");
    setUiState("idle");
  };

  const analyzeImage = async () => {
    if (!selectedImage) {
      Alert.alert("이미지 필요", "먼저 이미지를 선택해 주세요.");
      return;
    }
    if (!API_BASE_URL) {
      Alert.alert("환경 변수 오류", "EXPO_PUBLIC_API_SERVER_URL 값이 없습니다.");
      return;
    }

    setUiState("loading");
    setResult(null);
    setErrorMessage("");

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);

    try {
      const formData = new FormData();
      formData.append("file", {
        uri: selectedImage.uri,
        name: selectedImage.fileName,
        type: selectedImage.mimeType,
      } as never);

      const headers: Record<string, string> = {};
      if (token) headers.Authorization = `Bearer ${token}`;

      const res = await fetch(`${API_BASE_URL}/api/ai-check`, {
        method: "POST",
        headers,
        body: formData,
        signal: controller.signal,
      });

      const text = await res.text();
      const parsed = text ? (JSON.parse(text) as AiCheckResponse) : null;

      if (!res.ok || !parsed) {
        const msg = `요청 실패 (HTTP ${res.status})`;
        setUiState("error");
        setErrorMessage(msg);
        return;
      }

      setResult(parsed);
      setUiState("success");

      if (parsed.status === "quality_failed") {
        Alert.alert("품질 검사 실패", parsed.qualityReasons?.join("\n") || "사진 품질을 확인해 주세요.");
      }
      if (parsed.status === "error") {
        Alert.alert("분석 오류", "분석 중 서버 오류가 발생했습니다.");
      }
    } catch (e) {
      const message = e instanceof Error ? e.message : "네트워크 오류가 발생했습니다.";
      setUiState("error");
      setErrorMessage(message);
    } finally {
      clearTimeout(timeoutId);
    }
  };

  const openPdf = async () => {
    if (!result?.pdfUrl) return;
    const canOpen = await Linking.canOpenURL(result.pdfUrl);
    if (!canOpen) {
      Alert.alert("열기 실패", "PDF 링크를 열 수 없습니다.");
      return;
    }
    await Linking.openURL(result.pdfUrl);
  };

  return (
    <View className="flex-1 bg-slate-50">
      <SafeAreaView className="flex-1">
        <ScrollView contentContainerStyle={{ padding: 20, paddingBottom: 120 }}>
          <Text className="text-2xl font-bold text-slate-800">Run AI</Text>
          <Text className="text-sm text-slate-500 mt-2">이미지 업로드 후 AI 분석 결과를 확인하세요.</Text>

          <View className="flex-row gap-3 mt-6">
            <TouchableOpacity
              onPress={() => pickImage(true)}
              className="flex-1 bg-white rounded-2xl p-4 border border-slate-200"
              activeOpacity={0.85}
            >
              <Camera size={24} color="#0ea5e9" />
              <Text className="mt-2 font-semibold text-slate-700">카메라 촬영</Text>
            </TouchableOpacity>

            <TouchableOpacity
              onPress={() => pickImage(false)}
              className="flex-1 bg-white rounded-2xl p-4 border border-slate-200"
              activeOpacity={0.85}
            >
              <ImagePlus size={24} color="#0ea5e9" />
              <Text className="mt-2 font-semibold text-slate-700">갤러리 선택</Text>
            </TouchableOpacity>
          </View>

          {selectedImage && (
            <View className="mt-6 rounded-2xl overflow-hidden border border-slate-200 bg-black">
              <Image
                source={{ uri: selectedImage.uri }}
                style={{ width: "100%", height: 280 }}
                resizeMode="contain"
              />
            </View>
          )}

          <Button className="mt-6 rounded-xl" onPress={analyzeImage} disabled={!canAnalyze}>
            <Text className="text-white font-semibold">
              {uiState === "loading" ? "분석 중..." : "분석 실행"}
            </Text>
          </Button>

          {uiState === "loading" && (
            <View className="mt-6 bg-white border border-slate-200 rounded-2xl p-4 flex-row items-center gap-3">
              <ActivityIndicator />
              <Text className="text-slate-700">분석 중...</Text>
            </View>
          )}

          {uiState === "error" && (
            <View className="mt-6 bg-white border border-red-200 rounded-2xl p-4">
              <Text className="text-red-700 font-semibold">분석 실패</Text>
              <Text className="text-red-600 mt-2 text-sm">
                {errorMessage || "요청 중 오류가 발생했습니다."}
              </Text>
            </View>
          )}

          {uiState === "success" && result && (
            <View className="mt-6 gap-4">
              <View className="bg-white border border-slate-200 rounded-2xl p-4">
                <Text className="text-lg font-bold text-slate-800">분석 결과</Text>
                <Text className="text-sm text-slate-600 mt-2">Session ID: {result.sessionId}</Text>
                <Text className="text-sm text-slate-600 mt-1">Status: {result.status}</Text>
                <Text className="text-sm text-slate-600 mt-1">
                  Detections: {result.detections?.length ?? 0}개
                </Text>
                <Text className="text-slate-700 mt-3">
                  {result.llmResult?.overall?.oneLineSummary ?? "요약 정보가 없습니다."}
                </Text>
              </View>

              <View className="bg-white border border-slate-200 rounded-2xl p-4">
                <Text className="font-bold text-slate-800">탐지 목록 (최대 5개)</Text>
                {(result.detections?.length ?? 0) === 0 && (
                  <Text className="text-slate-600 mt-2">탐지 없음</Text>
                )}
                {(result.detections ?? []).slice(0, 5).map((d, idx) => (
                  <Text key={`det-${idx}`} className="text-slate-700 mt-2">
                    {idx + 1}. {d.label} ({d.confidence.toFixed(2)})
                  </Text>
                ))}
              </View>

              <View className="bg-white border border-slate-200 rounded-2xl p-4">
                <Button className="rounded-xl" onPress={openPdf} disabled={!result.pdfUrl}>
                  <Text className="text-white font-semibold">
                    {result.pdfUrl ? "리포트 열기" : "리포트 없음"}
                  </Text>
                </Button>
                {result.pdfUrl ? (
                  <Text className="text-xs text-slate-500 mt-2">{result.pdfUrl}</Text>
                ) : null}
              </View>
            </View>
          )}
        </ScrollView>
      </SafeAreaView>
    </View>
  );
}
